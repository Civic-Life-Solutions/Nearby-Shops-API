package org.nearbyshops.DAOPreparedSettings;


import com.zaxxer.hikari.HikariDataSource;
import org.nearbyshops.Globals.Globals;
import org.nearbyshops.ModelSettings.Settings;

import java.sql.*;


public class SettingsDAOPrepared {


	private HikariDataSource dataSource = Globals.getDataSource();


	@Override
	protected void finalize() throws Throwable {
		// TODO Auto-generated method stub
		super.finalize();	
	}


	public int saveSettings(Settings settings)
	{

		Connection connection = null;
		PreparedStatement statement = null;
		int rowIdOfInsertedRow = -1;

		String insertItemCategory = "INSERT INTO "
				+ Settings.TABLE_NAME
				+ "("
				+ Settings.SETTING_CONFIGURATION_ID + ","
				+ Settings.END_USER_ENABLED_DEFAULT + ","
				+ Settings.DISTRIBUTOR_ENABLED_DEFAULT + ","
				+ Settings.SHOP_ENABLED_BY_DEFAULT + ","
				+ Settings.GOOGLE_MAPS_API_KEY + ""

				+ " ) VALUES (?,?,?,?,?)";
		
		try {
			
			connection = dataSource.getConnection();
			statement = connection.prepareStatement(insertItemCategory,Statement.RETURN_GENERATED_KEYS);

			int i = 0;
			statement.setObject(++i,1);
			statement.setObject(++i,settings.getEndUserEnabledByDefault());
			statement.setObject(++i,settings.getDistributorEnabledByDefault());
			statement.setObject(++i,settings.isShopEnabledByDefault());
			statement.setString(++i,settings.getGoogleMapsAPIKey());

			rowIdOfInsertedRow = statement.executeUpdate();

			ResultSet rs = statement.getGeneratedKeys();

			if(rs.next())
			{
				rowIdOfInsertedRow = rs.getInt(1);
			}

			
			System.out.println("Key autogenerated Save CurrentServiceConfiguration: " + rowIdOfInsertedRow);
			
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		finally
		{
			
			try {
			
				if(statement!=null)
				{statement.close();}
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			try {
				
				if(connection!=null)
				{connection.close();}
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}

		
		return rowIdOfInsertedRow;
	}




	public int updateSettings(Settings settings)
	{

		// Ensure the service configuration row exist before being updated
		if(getSettings()==null){
			saveSettings(getDefaultConfiguration());
		}


		String updateStatement = "UPDATE " + Settings.TABLE_NAME

				+ " SET "
				+ Settings.END_USER_ENABLED_DEFAULT + "=?,"
				+ Settings.DISTRIBUTOR_ENABLED_DEFAULT + "=?,"
				+ Settings.SHOP_ENABLED_BY_DEFAULT + "=?,"
				+ Settings.GOOGLE_MAPS_API_KEY + "=?"
				+ " WHERE "
				+ Settings.SETTING_CONFIGURATION_ID + "=?";


		Connection connection = null;
		PreparedStatement statement = null;
		int updatedRows = -1;
		
		try {
			
			connection = dataSource.getConnection();
			statement = connection.prepareStatement(updateStatement);

			int i = 0;
			statement.setObject(++i,settings.getEndUserEnabledByDefault());
			statement.setObject(++i,settings.getDistributorEnabledByDefault());
			statement.setObject(++i,settings.isShopEnabledByDefault());
			statement.setString(++i,settings.getGoogleMapsAPIKey());
			statement.setObject(++i,1);

			updatedRows = statement.executeUpdate();

			System.out.println("Total rows updated: " + updatedRows);
			
			//conn.close();
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		finally
		
		{
			
			try {
			
				if(statement!=null)
				{statement.close();}
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			try {
				
				if(connection!=null)
				{connection.close();}
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}

		return updatedRows;
		
	}




	public int deleteSettings()
	{
		
		String deleteStatement = "DELETE FROM " + Settings.TABLE_NAME
				+ " WHERE " + Settings.SETTING_CONFIGURATION_ID + " = ?";
		
		
		Connection connection= null;
		PreparedStatement statement = null;
		int rowsCountDeleted = 0;
		try {
			
			connection = dataSource.getConnection();
			statement = connection.prepareStatement(deleteStatement);

			statement.setInt(1,1);
			rowsCountDeleted = statement.executeUpdate();
			System.out.println(" Deleted Count: " + rowsCountDeleted);

			connection.close();
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		finally
		
		{
			
			try {
			
				if(statement!=null)
				{statement.close();}
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			try {
				
				if(connection!=null)
				{connection.close();}
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	
		
		return rowsCountDeleted;
	}





	public Settings getSettings()
	{
		
		String query = "SELECT "
						+ Settings.SETTING_CONFIGURATION_ID + ","
						+ Settings.END_USER_ENABLED_DEFAULT + ","
						+ Settings.DISTRIBUTOR_ENABLED_DEFAULT + ","
						+ Settings.SHOP_ENABLED_BY_DEFAULT + ","
						+ Settings.GOOGLE_MAPS_API_KEY + ""
						+ " FROM " + Settings.TABLE_NAME
						+ " WHERE " + Settings.SETTING_CONFIGURATION_ID + " = " + 1;


		Connection connection = null;
		Statement statement = null;
		ResultSet rs = null;

		Settings settings = null;

		try {
			
			connection = dataSource.getConnection();
			statement = connection.createStatement();
			rs = statement.executeQuery(query);
			
			while(rs.next())
			{

				settings = new Settings();

				settings.setSettingsID(rs.getInt(Settings.SETTING_CONFIGURATION_ID));
				settings.setEndUserEnabledByDefault(rs.getBoolean(Settings.END_USER_ENABLED_DEFAULT));
				settings.setDistributorEnabledByDefault(rs.getBoolean(Settings.DISTRIBUTOR_ENABLED_DEFAULT));
				settings.setShopEnabledByDefault(rs.getBoolean(Settings.SHOP_ENABLED_BY_DEFAULT));
				settings.setGoogleMapsAPIKey(rs.getString(Settings.GOOGLE_MAPS_API_KEY));

			}

			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} finally
		
		{
			
			try {
					if(rs!=null)
					{rs.close();}
				} catch (SQLException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			
			try {
			
				if(statement!=null)
				{statement.close();}
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			try {
				
				if(connection!=null)
				{connection.close();}
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}

		if(settings == null)
		{
			saveSettings(getDefaultConfiguration());
		}
	
		return settings;
	}



	public Settings getDefaultConfiguration()
	{
		Settings settings = new Settings();

		settings.setEndUserEnabledByDefault(true);
		settings.setDistributorEnabledByDefault(false);
		settings.setGoogleMapsAPIKey("API-KEY-NOT-SET");

		return  settings;
	}



}
